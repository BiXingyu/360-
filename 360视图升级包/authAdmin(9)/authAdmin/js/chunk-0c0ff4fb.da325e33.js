(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-0c0ff4fb"],{"7fb2":function(t,e,i){},a9ec:function(t,e,i){"use strict";i("7fb2")},b505:function(t,e,i){"use strict";i("f760")},cdb4:function(t,e,i){"use strict";i.r(e);i("a450");var n=function(){var t=this,e=t._self._c;t._self._setupProxy;return e("div",{staticClass:"scriptMaintainContainer"},[e("div",{staticClass:"scriptMaintainDialog"},[e("div",{staticClass:"f1"},[e("div",{staticClass:"title-section title-section-first"},[e("span",{staticClass:"title"},[t._v("闭环类别")]),e("span",{staticClass:"content"},[t._v(t._s(t.$route.query.name))])]),e("div",{staticClass:"title-section"},[e("span",{staticClass:"title"},[t._v("闭环节点名称")]),e("span",{staticClass:"content"},[t._v(t._s(t.scriptMaintainItem.yzlbLcmc))])]),e("div",{staticClass:"title-section"},[e("span",{staticClass:"title"},[t._v("闭环节点编码")]),e("span",{staticClass:"content"},[t._v(t._s(t.scriptMaintainItem.yzlbLcid))])]),e("div",{staticClass:"title-section"},[e("span",{staticClass:"title"},[t._v("数据源")]),e("el-popover",{ref:"popRef",staticStyle:{width:"200px",position:"relative",top:"120px"},attrs:{placement:"right",trigger:"focus","visible-arrow":!1},model:{value:t.tooltipDisableFlag,callback:function(e){t.tooltipDisableFlag=e},expression:"tooltipDisableFlag"}},[t.popoverContent.dbClass||t.popoverContent.serverName?e("ul",{staticClass:"tips-content",staticStyle:{width:"300px"}},[e("li",[e("span",{staticStyle:{"font-weight":"bold"}},[t._v("数据源名称：")]),t._v("\n              "+t._s(t.popoverContent.dbClass)+"\n            ")]),e("li",[e("span",{staticStyle:{"font-weight":"bold"}},[t._v("数据库链接地址：")]),t._v("\n              "+t._s(t.popoverContent.serverName)+"\n            ")])]):e("span",[t._v(" 暂无数据... ")]),e("span",{attrs:{slot:"reference"},slot:"reference"},[e("el-select",{staticStyle:{width:"200px",position:"relative",top:"-120px"},on:{"visible-change":t.changeSelect},model:{value:t.initScriptMaintain.dbId,callback:function(e){t.$set(t.initScriptMaintain,"dbId",e)},expression:"initScriptMaintain.dbId"}},t._l(t.restData,(function(i){return e("el-option",{key:i.id,attrs:{placeholder:"请选择数据源",label:i.name,value:i.id},nativeOn:{mouseover:function(e){return t.setMouseOver(e,i)},mouseout:function(e){return t.setMouseOut()}}})})),1)],1)])],1)]),e("div",{staticClass:"f2"},[e("el-checkbox",{attrs:{disabled:t.isFirstNode},on:{change:function(e){t.moreInfos=""}},model:{value:t.timeRangeCheck,callback:function(e){t.timeRangeCheck=e},expression:"timeRangeCheck"}},[t._v("\n        时间范围：\n      ")]),e("el-date-picker",{ref:"datePicker",attrs:{type:"daterange",placeholder:"选择日期范围","unlink-panels":"","picker-options":t.pickerBeginDateBefore},model:{value:t.dateRangeVal,callback:function(e){t.dateRangeVal=e},expression:"dateRangeVal"}}),e("el-checkbox",{staticStyle:{"margin-left":"55px"},model:{value:t.mainKeyCheck,callback:function(e){t.mainKeyCheck=e},expression:"mainKeyCheck"}},[t._v("\n        主键 ("+t._s(t.initScriptMaintain.connectKey)+")：\n      ")]),e("el-input",{staticStyle:{width:"212px"},model:{value:t.mainKey,callback:function(e){t.mainKey=e},expression:"mainKey"}}),e("div",{staticClass:"f3"},[e("el-button",{attrs:{type:"primary"},nativeOn:{click:function(e){return t.scriptView.apply(null,arguments)}}},[t._v("\n          脚本预览\n        ")]),e("el-button",{attrs:{type:"primary"},nativeOn:{click:function(e){return t.excuteScript.apply(null,arguments)}}},[t._v("\n          执行脚本\n        ")]),e("el-button",{attrs:{type:"primary"},nativeOn:{click:function(e){return t.submitScript.apply(null,arguments)}}},[t._v("\n          保存脚本\n        ")])],1)],1),e("div",{ref:"f4",staticClass:"f4"},[e("div",{staticClass:"title"},[e("p",{domProps:{innerHTML:t._s(t.sqlResultStr)}})]),e("el-input",{staticStyle:{"margin-top":"10px"},attrs:{type:"textarea",placeholder:"select ... ...",autosize:{minRows:4,maxRows:6}},model:{value:t.textareaContent,callback:function(e){t.textareaContent=e},expression:"textareaContent"}}),t._v("\n      ) a\n      "),!0===t.timeRangeCheck||!0===t.mainKeyCheck?e("span",[t._v("\n        where\n      ")]):t._e(),!0===t.timeRangeCheck?e("span",[e("el-input",{staticStyle:{width:"280px",display:"inline-block","margin-top":"10px"},model:{value:t.moreInfos,callback:function(e){t.moreInfos=e},expression:"moreInfos"}}),t._v("\n        between\n        "),e("span",{staticClass:"f4-time-sql"},[t._v("\n          '"+t._s(this.$moment(t.dateRangeVal[0]).format("YYYY-MM-DD"))+"' and '"+t._s(this.$moment(t.dateRangeVal[1]).format("YYYY-MM-DD"))+"'\n        ")])],1):t._e(),!0===t.mainKeyCheck?e("span",[!0===t.timeRangeCheck&&!0===t.mainKeyCheck?e("span",[t._v("\n          and\n        ")]):t._e(),t._v("\n        a."+t._s(t.initScriptMaintain.connectKey)+" in ( "+t._s(t.mainKey)+" )\n      ")]):t._e()],1),e("div",{staticClass:"f5"},[e("div",{staticClass:"title"},[e("i",{staticClass:"title-icon"}),e("span",{staticClass:"result-title"},[t._v(" 查询结果： ")]),e("div",{staticClass:"result-message"},[t._v("\n          共查到\n          "),e("span",{staticStyle:{color:"red"}},[t._v("\n            "+t._s(t.sourceListContent.length)+"\n          ")]),t._v("\n          条数据\n        ")]),e("i",{directives:[{name:"show",rawName:"v-show",value:t.errorSituations||t.isFirstNode&&t.matchErrorSituations,expression:"errorSituations || (isFirstNode && matchErrorSituations)"}],staticClass:"el-icon-warning-outline"}),e("span",{directives:[{name:"show",rawName:"v-show",value:t.errorSituations,expression:"errorSituations"}],staticClass:"error-message"},[t._v("\n          执行病区和执行科室的内容不能同时为空！\n        ")]),e("span",{directives:[{name:"show",rawName:"v-show",value:t.isFirstNode&&t.matchErrorSituations,expression:"isFirstNode && matchErrorSituations"}],staticClass:"error-message"},[t._v("\n          闭环类别代码和规则匹配闭环类别不一致！\n        ")]),e("el-button",{staticClass:"add-to-first-closed-node",attrs:{type:"primary",disabled:t.multipleSelection.length<=0},nativeOn:{click:function(e){return t.handleInsertCloseLoop.apply(null,arguments)}}},[t._v("\n          插入闭环表\n        ")])],1),t.sourceListDatas&&t.sourceListDatas.length>0?e("div",{staticClass:"tableResult"},[e("el-table",{staticStyle:{width:"100%",border:"1px solid #c9c9c9"},attrs:{data:t.sourceListContent,border:"","tooltip-effect":"light","header-cell-style":{background:"#EAEEFE",color:"#000","font-weight":700,"font-size":"12px",borderColor:"#C9C9C9"},"cell-style":{borderColor:"#C9C9C9"}},on:{"selection-change":t.handleSelectionChange}},[e("el-table-column",{attrs:{type:"selection",width:"65",align:"center"}}),t._l(t.sourceListDatas,(function(i,n){return e("el-table-column",{key:n,attrs:{"render-header":t.formatHeader,prop:i.columnCode,label:i.columnName,"min-width":i.width?i.width:"140px","header-align":"center","show-overflow-tooltip":""},scopedSlots:t._u([{key:"default",fn:function(i){return[e("span",[t._v("\n                "+t._s(i.row[i.column.property])+"\n              ")])]}}],null,!0)})}))],2)],1):t._e()]),e("div",{directives:[{name:"show",rawName:"v-show",value:t.showLoading,expression:"showLoading"}],staticClass:"loading"},[t._m(0)])])])},a=[function(){var t=this,e=t._self._c;t._self._setupProxy;return e("p",[e("i",{staticClass:"el-icon-loading"})])}],s=(i("7afe"),i("a7e5"),i("d0f2"),i("fc02"),i("1bc7"),i("f13c")),o=i("ae5e"),c=i("acac"),r=i("2ad3"),l=i("e0e5"),u=i("fd63"),m=i("e4a1"),p=i("7c98"),h=i.n(p);function d(t){var e=f();return function(){var i,n=Object(l["a"])(t);if(e){var a=Object(l["a"])(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return Object(r["a"])(this,i)}}function f(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}var b={dateRangeVal:[]},v=function(t){Object(c["a"])(i,t);var e=d(i);function i(){var t;return Object(s["a"])(this,i),t=e.apply(this,arguments),t.closeLoopTypeData=[],t.pickerBeginDateBefore={disabledDate:function(t){return t.getTime()>Date.now()},onPick:function(e){var i=e.minDate.getTime()-6048e5;b.dateRangeVal=[t.$moment(new Date(i)).format("YYYY-MM-DD"),t.$moment(e.minDate).format("YYYY-MM-DD")],b.$refs.datePicker.handleClose()}},t.dateRangeVal=[t.$moment(new Date).format("YYYY-MM-DD"),t.$moment(new Date).add(1,"day").format("YYYY-MM-DD")],t.closeLoopItem={id:"",jlzt:2,lb:0,memo:"",mzzy:2,name:"",ywy:""},t.scriptMaintainItem={},t.initScriptMaintain={},t.restData=[],t.originalDbIdName="",t.mainKeyCheck=!1,t.timeRangeCheck=!1,t.isFirstNode=!1,t.mainKey="",t.moreInfos="",t.textareaContent="",t.sourceListDatas=[],t.sourceListContent=[],t.errorSituations=!1,t.errorSituationStr="",t.matchErrorSituations=!1,t.matchErrorSituationStr="",t.showLoading=!1,t.yzlbLcidText="",t.bhlbbmText="",t.firstSqlStr="",t.secondSqlStr="",t.prefixSqlStr="",t.popoverContent={},t.tooltipDisableFlag=!1,t.multipleSelection=[],t.sqlResultStr="",t}return Object(o["a"])(i,[{key:"mounted",value:function(){b=this,this.scriptMaintainItem=this.$route.query,this.yzlbLcidText="'"+this.scriptMaintainItem.yzlbLcid+"'",this.bhlbbmText="'"+this.scriptMaintainItem.yzlbdm+"'",this.initscriptMaintain(this.$route.query)}},{key:"handleInsertCloseLoop",value:function(){var t=this,e=JSON.stringify(this.multipleSelection);console.log(e),this.$api.saveExecSqlScript(this.multipleSelection).then((function(e){console.log(e),200===e.status&&t.$message.success("插入成功")})).catch((function(e){t.$message.error(e)}))}},{key:"handleSelectionChange",value:function(t){this.multipleSelection=t}},{key:"setMouseOver",value:function(t,e){this.tooltipDisableFlag=!0,this.popoverContent=e}},{key:"setMouseOut",value:function(){this.tooltipDisableFlag=!1}},{key:"changeSelect",value:function(){this.tooltipDisableFlag=!1,this.popoverContent={}}},{key:"initscriptMaintain",value:function(t){var e=this,i={bhlbdm:t.yzlbdm,bhlbLcid:t.yzlbLcid};this.$api.getSqlScript(i).then((function(t){if(e.initScriptMaintain=t.data,console.log(e.yzlbLcidText),e.textareaContent=t.data.middleSql,e.sourceListDatas=t.data.columnList,e.sourceListDatas.forEach((function(t){"执行科室"!==t.columnName&&"处方类型"!==t.columnName||(t.width="90px")})),e.initScriptMaintain.firstNode&&(e.isFirstNode=!0,e.timeRangeCheck=!0,e.moreInfos=e.initScriptMaintain.timestampKey),e.initScriptMaintain.timestampKey&&(e.timeRangeCheck=!0,e.moreInfos=e.initScriptMaintain.timestampKey),e.initScriptMaintain.prefixSql){var i=e.initScriptMaintain.prefixSql,n=i.indexOf(e.yzlbLcidText),a=i.indexOf(e.bhlbbmText),s=i.split(e.yzlbLcidText)[0].split(e.bhlbbmText).concat(i.split(e.yzlbLcidText)[1].split(e.bhlbbmText));n<0&&(e.yzlbLcidText=""),a<0&&(e.bhlbbmText=""),e.sqlResultStr=n>a?"".concat(s[0],"<span class='f4-time-sql'>").concat(e.bhlbbmText,"</span>").concat(s[1],"<span class='f4-time-sql'>").concat(e.yzlbLcidText,"</span>").concat(s[2]):"".concat(s[0],"<span class='f4-time-sql'>").concat(e.yzlbLcidText,"</span>").concat(s[1],"<span class='f4-time-sql'>").concat(e.bhlbbmText,"</span>").concat(s[2])}e.initLinkServers()})).catch((function(t){e.$message.error(t)}))}},{key:"initLinkServers",value:function(){var t=this;this.$api.getLinkServers().then((function(e){t.restData=e.data,t.restData.forEach((function(e){e.id===t.initScriptMaintain.dbId&&(t.originalDbIdName=e.name)}))})).catch((function(e){t.$message.error(e)}))}},{key:"checkContenct",value:function(){var t=/drap\s|delete\s|alter\s/gi;if(this.textareaContent&&this.initScriptMaintain.dbId){if(this.timeRangeCheck&&!this.moreInfos)return this.$message({message:"时间范围查询内容不能为空",type:"warning"}),!1;if(this.mainKeyCheck&&!this.mainKey)return this.$message({message:"主键内容不能为空",type:"warning"}),!1;if(t.test(this.textareaContent)){var e=this.textareaContent.match(t);return this.$message({message:"数据脚本内容不能包含'".concat(e.join(),"'"),type:"warning"}),!1}return!0}return this.$message({message:"数据源 和 数据脚本 不能为空",type:"warning"}),!1}},{key:"submitScript",value:function(){var t=this,e=this.checkContenct();e&&(this.showLoading=!0);var i={middleSql:this.textareaContent,bhlbLcid:this.scriptMaintainItem.yzlbLcid,bhlbdm:this.scriptMaintainItem.yzlbdm,dbId:this.initScriptMaintain.dbId,timestampKey:this.moreInfos};e&&this.$api.saveSqlScript(i).then((function(e){t.showLoading=!1,200===e.status&&t.$message.success("保存成功");var i="";t.restData.forEach((function(e){t.initScriptMaintain.dbId===e.id&&(i=e.name)})),t.$api.saveUpdateSql({bhlbdm:t.scriptMaintainItem.yzlbdm,bhjddm:t.scriptMaintainItem.yzlbLcid,updateSql:t.textareaContent,sqlJson:t.initScriptMaintain.middleSql,xgsjy:i,sjy:t.originalDbIdName}),t.initscriptMaintain(t.$route.query)})).catch((function(e){t.showLoading=!1,t.$message.error(e)}))}},{key:"excuteScript",value:function(){var t=this,e=this.checkContenct();e&&(this.showLoading=!0);var i={sql:"".concat(this.initScriptMaintain.prefixSql).concat(this.textareaContent," ) a ").concat(this.timeRangeCheck||this.mainKeyCheck?"where":"").concat(this.timeRangeCheck?" ".concat(this.moreInfos," between '").concat(this.$moment(this.dateRangeVal[0]).format("YYYY-MM-DD"),"' and '").concat(this.$moment(this.dateRangeVal[1]).format("YYYY-MM-DD"),"'"):"").concat(this.mainKeyCheck?" ".concat(this.timeRangeCheck&&this.mainKeyCheck?" and ":""," a.").concat(this.initScriptMaintain.connectKey," in (").concat(this.mainKey,")"):""),dbId:this.initScriptMaintain.dbId,isFirstNode:this.isFirstNode,connectKey:this.initScriptMaintain.connectKey};e&&this.$api.execSqlScript(i).then((function(e){if(t.showLoading=!1,200===e.status){t.sourceListContent=e.data;var i=[],n=[];t.sourceListContent.forEach((function(e,a){e.zxbq||e.zxks||i.push(a),t.isFirstNode&&e.bhlbdm!==e.bhlbdm_actual&&n.push(a)})),t.errorSituations=i.length>0,t.errorSituationStr=i.join(","),t.matchErrorSituations=n.length>0,t.matchErrorSituationStr=n.join(","),t.$message.success("执行成功"),t.initScriptMaintain.columnList.forEach((function(e){e.columnNotNull&&1===e.columnNotNull&&h.a.findIndex(t.sourceListContent,(function(t){return!t[e.columnCode]&&0!==t[e.columnCode]}))>=0&&(console.log(e.columnName+"（必填）"),t.$message.warning(e.columnName+"（必填）"))}))}})).catch((function(e){t.showLoading=!1,t.$message.error(e)}))}},{key:"scriptView",value:function(){var t=this.checkContenct(),e="".concat(this.initScriptMaintain.prefixSql).concat(this.textareaContent," ) a ").concat(this.timeRangeCheck||this.mainKeyCheck?"where":"").concat(this.timeRangeCheck?" ".concat(this.moreInfos," between '").concat(this.$moment(this.dateRangeVal[0]).format("YYYY-MM-DD"),"' and '").concat(this.$moment(this.dateRangeVal[1]).format("YYYY-MM-DD"),"'"):"").concat(this.mainKeyCheck?" ".concat(this.timeRangeCheck&&this.mainKeyCheck?" and ":""," a.").concat(this.initScriptMaintain.connectKey," in (").concat(this.mainKey,")"):"");t&&this.$alert(e,"脚本预览",{confirmButtonText:"确定",customClass:"message_box_alert"})}},{key:"formatHeader",value:function(t,e){var i=e.column,n=e.$index;return t("div",[t("span",{style:{color:"red"}},1===this.sourceListDatas[n-1].columnNotNull?"* ":""),t("span",i.label)])}}]),i}(m["c"]);v=Object(u["a"])([Object(m["a"])({name:"scriptMaintain"})],v);var y=v,g=y,C=(i("a9ec"),i("b505"),i("0b56")),S=Object(C["a"])(g,n,a,!1,null,"2de0e9f0",null);e["default"]=S.exports},f760:function(t,e,i){}}]);